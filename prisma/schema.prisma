// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// Device Model
model Device {
  id                      String        @id @default(cuid())
  deviceId                String        @unique
  name                    String?
  accountAssociatedSince  Int?
  mainDevice              Boolean       @default(false)
  prosumer                Boolean       @default(false)
  division                Int           @default(0) // Divisions enum as Int
  
  currentData             CurrentData[]
  operatingReports        OperatingReport[]
  reports                 Report[]
  monthlyReportValues     MonthlyReportValue[]
  dailyReportValues       DailyReportValue[]
  hourlyReportValues      HourlyReportValue[]
  quarterHourlyReportValues QuarterHourlyReportValue[]
  
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  
  @@index([deviceId])
}

// Current Data Model - Aktuelle Messwerte
model CurrentData {
  id                  String    @id @default(cuid())
  deviceId            String
  device              Device    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  
  outdated            Boolean   @default(false)
  unit                String    @default("wh")  // "wh" oder "kwh"
  watt                Float?
  kiloWattHour        Float?
  deltaKiloWattHour   Float?
  cubicMeterCold      Float?
  cubicMeterWarm      Float?
  cubicMeter          Float?
  deltaCubicMeter     Float?
  timestamp           Int?
  aPlus               Float?
  aPlusHT             Float?
  aPlusNT             Float?
  aMinus              Float?
  l1                  Float?
  l2                  Float?
  l3                  Float?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@index([deviceId])
  @@index([timestamp])
}

// Operating Report Model - Betriebsberichte
model OperatingReport {
  id                  String                    @id @default(cuid())
  deviceId            String
  device              Device                    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  
  max                 Float?
  min                 Float?
  avg                 Float?
  
  values              OperatingReportValue[]    @relation("ReportValues")
  valuesPlus          OperatingReportValue[]    @relation("ReportValuesPlus")
  valuesMinus         OperatingReportValue[]    @relation("ReportValuesMinus")
  
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  
  @@index([deviceId])
}

// Operating Report Value Model - Einzelne Messwerte im Betriebsbericht
model OperatingReportValue {
  id                      String            @id @default(cuid())
  timestamp               Int?
  value                   Float?
  
  operatingReportId       String?
  operatingReport         OperatingReport?  @relation("ReportValues", fields: [operatingReportId], references: [id], onDelete: Cascade)
  
  operatingReportPlusId   String?
  operatingReportPlus     OperatingReport?  @relation("ReportValuesPlus", fields: [operatingReportPlusId], references: [id], onDelete: Cascade)
  
  operatingReportMinusId  String?
  operatingReportMinus    OperatingReport?  @relation("ReportValuesMinus", fields: [operatingReportMinusId], references: [id], onDelete: Cascade)
  
  createdAt               DateTime          @default(now())
  
  @@index([timestamp])
}

// Report Model - Hauptbericht mit verschiedenen Zusammenfassungen
model Report {
  id                  String                @id @default(cuid())
  deviceId            String
  device              Device                @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  
  consumption         ReportSummaryPower?   @relation("Consumption")
  ownConsumption      ReportSummaryPower?   @relation("OwnConsumption")
  feedIn              ReportSummaryPower?   @relation("FeedIn")
  generation          ReportSummaryPower?   @relation("Generation")
  heat                ReportSummaryHeat?
  gas                 ReportSummaryGas?
  water               ReportSummaryWater?
  
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  
  @@index([deviceId])
}

// Report Summary Power - Strom-Zusammenfassung
model ReportSummaryPower {
  id                      String                @id @default(cuid())
  summaryType             String                // "consumption", "ownConsumption", "feedIn", "generation"
  
  sumCurrency             Float?
  startTime               Int?
  startTimeCurrency       Float?
  sum                     Float?
  max                     Float?
  maxCurrency             Float?
  
  reportConsumptionId     String?               @unique
  reportConsumption       Report?               @relation("Consumption", fields: [reportConsumptionId], references: [id], onDelete: Cascade)
  
  reportOwnConsumptionId  String?               @unique
  reportOwnConsumption    Report?               @relation("OwnConsumption", fields: [reportOwnConsumptionId], references: [id], onDelete: Cascade)
  
  reportFeedInId          String?               @unique
  reportFeedIn            Report?               @relation("FeedIn", fields: [reportFeedInId], references: [id], onDelete: Cascade)
  
  reportGenerationId      String?               @unique
  reportGeneration        Report?               @relation("Generation", fields: [reportGenerationId], references: [id], onDelete: Cascade)
  
  meterReadings           ReportMeterReading[]
  reportValues            ReportValue[]
  
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
}

// Report Summary Heat - Wärme-Zusammenfassung
model ReportSummaryHeat {
  id                      String                @id @default(cuid())
  reportId                String                @unique
  report                  Report                @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  sumCurrency             Float?
  sumCubicMeter           Float?
  maxCubicMeter           Float?
  sumKiloWattHour         Float?
  maxKiloWattHour         Float?
  
  meterReadings           ReportMeterReading[]
  reportValues            ReportValue[]
  
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  
  @@index([reportId])
}

// Report Summary Gas - Gas-Zusammenfassung
model ReportSummaryGas {
  id                      String                @id @default(cuid())
  reportId                String                @unique
  report                  Report                @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  sumCurrency             Float?
  totalDelta              Float?
  sum                     Float?
  totalDeltaCurrency      Float?
  currentConsumptionKwh   Float?
  currentConsumption      Float?
  consumptionKWh          Float?
  consumption             Float?
  max                     Float?
  maxCurrency             Float?
  maxConsumption          Float?
  maxConsumptionKWh       Float?
  min                     Float?
  minConsumption          Float?
  minConsumptionKWh       Float?
  avgDelta                Float?
  avgConsumption          Float?
  avgConsumptionKWh       Float?
  
  meterReadings           ReportMeterReading[]
  reportValues            ReportValue[]
  
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  
  @@index([reportId])
}

// Report Summary Water - Wasser-Zusammenfassung
model ReportSummaryWater {
  id                      String                @id @default(cuid())
  reportId                String                @unique
  report                  Report                @relation(fields: [reportId], references: [id], onDelete: Cascade)
  
  sumCurrency             Float?
  sumCurrencyCold         Float?
  sumCubicMeterCold       Float?
  maxCubicMeterCold       Float?
  sumCurrencyWarm         Float?
  sumCubicMeterWarm       Float?
  maxCubicMeterWarm       Float?
  
  meterReadings           ReportMeterReading[]
  reportValues            ReportValue[]
  
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  
  @@index([reportId])
}

// Report Meter Reading - Zählerstände
model ReportMeterReading {
  id                      String                @id @default(cuid())
  value                   Float?
  type                    Int?                  // MeterReadingType enum as Int
  
  reportSummaryPowerId    String?
  reportSummaryPower      ReportSummaryPower?   @relation(fields: [reportSummaryPowerId], references: [id], onDelete: Cascade)
  
  reportSummaryHeatId     String?
  reportSummaryHeat       ReportSummaryHeat?    @relation(fields: [reportSummaryHeatId], references: [id], onDelete: Cascade)
  
  reportSummaryGasId      String?
  reportSummaryGas        ReportSummaryGas?     @relation(fields: [reportSummaryGasId], references: [id], onDelete: Cascade)
  
  reportSummaryWaterId    String?
  reportSummaryWater      ReportSummaryWater?   @relation(fields: [reportSummaryWaterId], references: [id], onDelete: Cascade)
  
  createdAt               DateTime              @default(now())
}

// Report Value - Berichtswerte
model ReportValue {
  id                      String                @id @default(cuid())
  deviceId                String?
  timestamp               Int?
  complete                Boolean               @default(false)
  delta                   Float?
  totalDelta              Float?
  totalDeltaCurrency      Float?
  deltaHT                 Float?
  deltaNT                 Float?
  deltaCurrency           Float?
  consumption             Float?
  consumptionKWh          Float?
  amountOfValuesAdded     Float?
  deltaKiloWattHour       Float?
  deltaCubicMeter         Float?
  deltaCubicMeterCold     Float?
  deltaCubicMeterWarm     Float?
  deltaCurrencyCold       Float?
  deltaCurrencyWarm       Float?
  currentConsumption      Float?
  currentConsumptionKwh   Float?
  valuesType              Int?                  // ValuesType enum as Int
  
  reportSummaryPowerId    String?
  reportSummaryPower      ReportSummaryPower?   @relation(fields: [reportSummaryPowerId], references: [id], onDelete: Cascade)
  
  reportSummaryHeatId     String?
  reportSummaryHeat       ReportSummaryHeat?    @relation(fields: [reportSummaryHeatId], references: [id], onDelete: Cascade)
  
  reportSummaryGasId      String?
  reportSummaryGas        ReportSummaryGas?     @relation(fields: [reportSummaryGasId], references: [id], onDelete: Cascade)
  
  reportSummaryWaterId    String?
  reportSummaryWater      ReportSummaryWater?   @relation(fields: [reportSummaryWaterId], references: [id], onDelete: Cascade)
  
  createdAt               DateTime              @default(now())
  
  @@index([timestamp])
  @@index([deviceId])
}

// API Log Model - Logging aller API-Aufrufe
model ApiLog {
  id                  String    @id @default(cuid())
  
  // Request Information
  endpoint            String    // z.B. "all/devices", "{deviceId}/current"
  method              String    // GET, POST, etc.
  params              String?   // JSON string der Parameter
  
  // Response Information
  statusCode          Int
  success             Boolean   @default(true)
  responseData        String?   // JSON string der Response
  errorMessage        String?
  
  // Metadata
  duration            Int?      // Dauer in Millisekunden
  timestamp           DateTime  @default(now())
  
  @@index([endpoint])
  @@index([timestamp])
  @@index([success])
}

// Monthly Report Value - Monatswerte (nur Jahr)
// Werte sind in kWh (nicht Watt)
model MonthlyReportValue {
  id                  String    @id @default(cuid())
  deviceId            String
  device              Device    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  
  year                Int
  month               Int       // 1-12
  timestamp           Int       // Unix timestamp
  
  kWh                 Float?    // Wert in kWh
  aPlus               Float?    // Wert in kWh
  aMinus              Float?    // Wert in kWh
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([deviceId, year, month])
  @@index([deviceId])
  @@index([year, month])
  @@index([timestamp])
}

// Daily Report Value - Tageswerte (Jahr + Monat)
// Werte sind in kWh (nicht Watt)
model DailyReportValue {
  id                  String    @id @default(cuid())
  deviceId            String
  device              Device    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  
  year                Int
  month               Int       // 1-12
  day                 Int       // 1-31
  timestamp           Int       // Unix timestamp
  
  kWh                 Float?    // Wert in kWh
  aPlus               Float?    // Wert in kWh
  aMinus              Float?    // Wert in kWh
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([deviceId, year, month, day])
  @@index([deviceId])
  @@index([year, month, day])
  @@index([timestamp])
}

// Hourly Report Value - Stundenwerte (Jahr + Monat + Tag)
// Werte sind in kWh (nicht Watt)
model HourlyReportValue {
  id                  String    @id @default(cuid())
  deviceId            String
  device              Device    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  
  year                Int
  month               Int       // 1-12
  day                 Int       // 1-31
  hour                Int       // 0-23
  timestamp           Int       // Unix timestamp
  
  kWh                 Float?    // Wert in kWh
  aPlus               Float?    // Wert in kWh
  aMinus              Float?    // Wert in kWh
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([deviceId, year, month, day, hour])
  @@index([deviceId])
  @@index([year, month, day, hour])
  @@index([timestamp])
}

// Quarter Hourly Report Value - Viertelstundenwerte (Jahr + Monat + Tag + fromHour)
model QuarterHourlyReportValue {
  id                  String    @id @default(cuid())
  deviceId            String
  device              Device    @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)
  
  year                Int
  month               Int       // 1-12
  day                 Int       // 1-31
  hour                Int       // 0-23
  minute              Int       // 0, 15, 30, 45
  timestamp           Int       // Unix timestamp
  
  watt                Float?
  aPlus               Float?
  aMinus              Float?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([deviceId, year, month, day, hour, minute])
  @@index([deviceId])
  @@index([year, month, day, hour, minute])
  @@index([timestamp])
}
